int min(int x, int y);
int max(int x, int y);

int median_of_three(int array[], int64_t low, int64_t high) {
  if (high - low < 2) {
    return array[high];
  }

  int mid = (low + high) / 2;
  int x = array[low];
  int y = array[mid];
  int z = array[high];

  int smallest = min(min(x, y), z);
  int largest = max(max(x, y), z);
  int median = x + y + z - smallest - largest;

  array[low] = smallest;
  array[high] = median;
  array[mid] = largest;

  return median;
}

inline void sort_pair(int *i1, int *i2) {
  int x = *i1;
  int y = *i2;
  int c = x < y;
  *i1 = c ? x : y;
  *i2 = c ? y : x;
}

inline int median_of_three_auto_finish(int array[], int64_t low, int64_t high, int *done) {
  if (high - low == 1) {
    *done = true;
    sort_pair(&array[low], &array[high]);
    return array[high];
  }

  int mid = (low + high) / 2;
  int x = array[low];
  int y = array[mid];
  int z = array[high];

  sort_pair(&x, &y);
  sort_pair(&y, &z);
  sort_pair(&x, &y);

  if (high - low == 2) {
    *done = true;
    array[low] = x;
    array[mid] = y;
    array[high] = z;
    return y;
  }

  array[low] = x;
  array[high] = y;
  array[mid] = z;

  return y;
}

void sort_indexes(int array[], int64_t *i1, int64_t *i2) {
  int x = *i1;
  int y = *i2;
  int c = array[*i1] < array[*i2];
  *i1 = c ? x : y;
  *i2 = c ? y : x;
}

int median_of_three_stable(int array[], int64_t low, int64_t high) {
  if (high - low > 2) {
    int64_t offset = (high - low) / 3;
    int64_t lowmid = low + offset;
    int64_t highmid = low + offset + offset;
    sort_indexes(array, &low, &lowmid);
    sort_indexes(array, &lowmid, &highmid);
    sort_indexes(array, &highmid, &high);
    sort_indexes(array, &low, &lowmid);
    sort_indexes(array, &lowmid, &highmid);
    sort_indexes(array, &low, &lowmid);

    return array[lowmid];

    /*int64_t mid = (low + high) / 2;
    sort_indexes(array, &low, &mid);
    sort_indexes(array, &mid, &high);
    sort_indexes(array, &low, &mid);
    return array[mid];*/

  } if (high - low == 2) {
    int64_t mid = low + 1;
    sort_pair(&array[low], &array[mid]);
    sort_pair(&array[mid], &array[high]);
    sort_pair(&array[low], &array[mid]);
    return array[mid];
  } else if (high - low == 1) {
    sort_pair(&array[low], &array[high]);
    return array[high];
  } else {
    return array[high];
  }
}

int median_of_three_of_median_of_three_auto_finish(int array[], int64_t low, int64_t high, int *done) {
  if (high - low > 30) {
    //int64_t offset = (high - low) / 9;
    //int a = array[low];
    //int b = array[low + offset * 1];
    //int c = array[low + offset * 2];
    //sort_pair(&a, &b);
    //sort_pair(&b, &c);
    //sort_pair(&a, &b);

    //int d = array[low + offset * 3];
    //int e = array[low + offset * 4];
    //int f = array[low + offset * 5];
    //sort_pair(&d, &e);
    //sort_pair(&e, &f);
    //sort_pair(&d, &e);

    //int g = array[low + offset * 6];
    //int h = array[low + offset * 7];
    //int i = array[high];
    //sort_pair(&g, &h);
    //sort_pair(&h, &i);
    //sort_pair(&g, &h);
    //
    //sort_pair(&b, &e);
    //sort_pair(&e, &h);
    //sort_pair(&b, &e);

    //array[low] = a;
    //array[low + offset * 1] = b;
    //array[low + offset * 2] = d;
    //array[low + offset * 3] = g;
    //array[low + offset * 4] = c;
    //array[low + offset * 5] = f;
    //array[low + offset * 6] = h;
    //array[low + offset * 7] = i;
    //array[high] = e;

    //printf("Median of three of median of three: %d\n", y);

    //int64_t offset = (high - low) / 9;
    //sort_pair(&array[low], &array[low + offset * 1]);
    //sort_pair(&array[low + offset * 1], &array[low + offset * 2]);
    //sort_pair(&array[low], &array[low + offset * 1]);
    //sort_pair(&array[low + offset * 3], &array[low + offset * 4]);
    //sort_pair(&array[low + offset * 4], &array[low + offset * 5]);
    //sort_pair(&array[low + offset * 3], &array[low + offset * 4]);
    //sort_pair(&array[low + offset * 6], &array[low + offset * 7]);
    //sort_pair(&array[low + offset * 7], &array[high]);
    //sort_pair(&array[low + offset * 6], &array[low + offset * 7]);
    //sort_pair(&array[low + offset * 1], &array[low + offset * 4]);
    //sort_pair(&array[low + offset * 4], &array[low + offset * 7]);
    //sort_pair(&array[low + offset * 1], &array[low + offset * 4]);

    //swap(&array[low + offset * 4], &array[high]);

    int64_t offset = (high - low) / 9;

    int64_t a = low;
    int64_t b = low + offset;
    int64_t c = low + offset * 2;
    sort_indexes(array, &a, &b);
    sort_indexes(array, &b, &c);
    sort_indexes(array, &a, &b);

    int64_t d = low + offset * 3;
    int64_t e = low + offset * 4;
    int64_t f = low + offset * 5;
    sort_indexes(array, &d, &e);
    sort_indexes(array, &e, &f);
    sort_indexes(array, &d, &e);
    
    int64_t g = low + offset * 6;
    int64_t h = low + offset * 7;
    int64_t i = high;
    sort_indexes(array, &g, &h);
    sort_indexes(array, &h, &i);
    sort_indexes(array, &g, &h);
    
    sort_indexes(array, &b, &e);
    sort_indexes(array, &e, &h);
    sort_indexes(array, &b, &e);

    swap(&array[e], &array[high]);

    return array[high];
  } else {
    return median_of_three_auto_finish(array, low, high, done);
  }
}