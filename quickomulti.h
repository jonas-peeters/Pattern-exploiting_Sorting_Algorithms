#include <stdbool.h>
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

#include <emmintrin.h> //SSE2
#include <immintrin.h> //AVX, AVX2, AVX-512
#include <nmmintrin.h> //SSE4.2
#include <pmmintrin.h> //SSE3
#include <smmintrin.h> //SSE4.1
#include <xmmintrin.h> //for SSE

void swap(int *a, int *b);
int median_of_three(int array[], int low, int high);
void insertionSortOptimized(int array[], int n);
void sort_quick_optimized(int array[], int low, int high);
int x[2];

uint32_t hsum_epi32_avx(__m128i x) {
  __m128i hi64 = _mm_unpackhi_epi64(x, x);
  __m128i sum64 = _mm_add_epi32(hi64, x);
  __m128i hi32 = _mm_shuffle_epi32(sum64, _MM_SHUFFLE(2, 3, 0, 1));
  __m128i sum32 = _mm_add_epi32(sum64, hi32);
  return _mm_cvtsi128_si32(sum32);
}

uint32_t hsum_8x32(__m256i v) {
  __m128i sum128 =
      _mm_add_epi32(_mm256_castsi256_si128(v), _mm256_extracti128_si256(v, 1));
  return hsum_epi32_avx(sum128);
}

int tmp[9000000];

void partition_quick_multi(int array[], int low, int high, int targets[]) {
  int64_t size = high - low;
  __m256i zeros = _mm256_set1_epi32(0);
  __m256i pivots = _mm256_loadu_si256((__m256i *)&array[low]);

  int64_t i = low;

  for (int64_t j = low; j < high; j++) {
    __m256i currentValue = _mm256_set1_epi32(array[j]);
    __m256i compares = _mm256_cmpgt_epi32(pivots, currentValue);

    int64_t index = 8 + hsum_8x32(compares);
    tmp[targets[index]] = array[j];
    targets[index] += 1;
  }

  int64_t arrayIndex = low;

  for (int64_t index = 0; index < 9; index++) {
    int64_t j = index * size;
    for (; j < targets[index] - 8; j += 8) {
      _mm256_storeu_si256((__m256i *)&array[arrayIndex],
                          _mm256_loadu_si256((__m256i *)&tmp[j]));
      arrayIndex += 8;
    }
    for (; j < targets[index]; j++) {
      array[arrayIndex] = tmp[j];
      arrayIndex++;
    }
    targets[index] -= index * size;
  }
  // printf("Array ");
  // for (int64_t index = 0; index < 40; index++) {
  //   printf("%d ", array[index]);
  // }
  // printf("\n");
}

void sort_quick_multi(int array[], int low, int high) {
  // printf("Sorting from %d to %d\n", low, high);
  if (low < high) {
    if (high - low > 200) {
      int64_t size = high - low + 1;
      int pivots[9] = {0,        size * 1, size * 2, size * 3, size * 4,
                       size * 5, size * 6, size * 7, size * 8};
      partition_quick_multi(array, low, high + 1, pivots);
      // printf("Pivots ");
      // for (int64_t index = 0; index < 9; index++) {
      //   printf("%d ", pivots[index]);
      // }
      // printf("\n");

      int start = low;

      for (int64_t index = 0; index < 9; index++) {
        int end = start + pivots[index];
        sort_quick_multi(array, start, end - 1);
        start = end;
      }
    } else {
      sort_quick_optimized(array, low, high);
      // insertionSortOptimized(array + low, high - low + 1);
    }
  }
}
