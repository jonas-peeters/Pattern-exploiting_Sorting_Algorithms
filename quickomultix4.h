#include <stdbool.h>
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

#include <emmintrin.h> //SSE2
#include <immintrin.h> //AVX, AVX2, AVX-512
#include <nmmintrin.h> //SSE4.2
#include <pmmintrin.h> //SSE3
#include <smmintrin.h> //SSE4.1
#include <xmmintrin.h> //for SSE

void swap(int *a, int *b);
void insertionSortOptimized(int array[], int n);
void sort_quick_optimized(int array[], int64_t low, int64_t high);
uint32_t hsum_epi32_avx(__m128i v);
int x[2];

void partition_quick_multix4(int array[], int64_t low, int64_t high, int targets[],
                             int tmp[]) {
  int64_t size = high - low;
  __m128i pivots = _mm_loadu_si128((__m128i *)&array[low]);

  int64_t i = low;

  for (int64_t j = low; j < high; j++) {
    __m128i currentValue = _mm_set1_epi32(array[j]);
    __m128i compares = _mm_cmpgt_epi32(pivots, currentValue);

    int64_t index = 4 + hsum_epi32_avx(compares);
    tmp[targets[index]] = array[j];
    targets[index] += 1;
  }

  int64_t arrayIndex = low;

  for (int64_t index = 0; index <= 4; index++) {
    int64_t j = index * size;
    for (; j < targets[index] - 7; j += 8) {
      _mm256_storeu_si256((__m256i *)&array[arrayIndex],
                          _mm256_loadu_si256((__m256i *)&tmp[j]));
      arrayIndex += 8;
    }
    for (; j < targets[index]; j++) {
      array[arrayIndex] = tmp[j];
      arrayIndex++;
    }
    targets[index] -= index * size;
  }
}

void sort_quick_multix4_h(int array[], int64_t low, int64_t high, int tmp[]) {
  if (low < high) {
    if (high - low > 40) {
      int size = high - low + 1;
      int pivots[5] = {0, size * 1, size * 2, size * 3, size * 4};
      partition_quick_multix4(array, low, high + 1, pivots, tmp);

      int64_t start = low;

      for (int64_t index = 0; index <= 4; index++) {
        int64_t end = start + pivots[index];
        sort_quick_multix4_h(array, start, end - 1, tmp);
        start = end;
      }
    } else {
      sort_quick_optimized(array, low, high);
    }
  }
}

void sort_quick_multix4(int array[], int64_t low, int64_t high) {
  int *tmp = (int *) malloc(sizeof(int32_t) * (high - low) * 5);
  sort_quick_multix4_h(array, low, high, tmp);
  free(tmp);
}
